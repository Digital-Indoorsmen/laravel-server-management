policy_module(panel, 1.0.0)

########################################
#
# Declarations
#

## Booleans
bool panel_can_manage_users false;
bool panel_can_reload_nginx false;

type laravel_app_t;
type laravel_app_exec_t;
init_daemon_domain(laravel_app_t, laravel_app_exec_t)

type laravel_php_fpm_t;
type laravel_php_fpm_exec_t;
init_daemon_domain(laravel_php_fpm_t, laravel_php_fpm_exec_t)

type laravel_nginx_t;
type laravel_nginx_exec_t;
init_daemon_domain(laravel_nginx_t, laravel_nginx_exec_t)

type laravel_ssh_key_t;
type laravel_ssh_key_exec_t;
init_daemon_domain(laravel_ssh_key_t, laravel_ssh_key_exec_t)

type site_content_t;
files_type(site_content_t)

type laravel_app_rw_t;
files_type(laravel_app_rw_t)

########################################
#
# Local policy
#

require {
    type mysqld_port_t;
    type postgresql_port_t;
}

# Allow Nginx to read site content
allow laravel_nginx_t site_content_t:dir list_dir_perms;
allow laravel_nginx_t site_content_t:file read_file_perms;

# Allow PHP-FPM to read/write specific app paths
allow laravel_php_fpm_t laravel_app_rw_t:dir rw_dir_perms;
allow laravel_php_fpm_t laravel_app_rw_t:file rw_file_perms;

# Allow PHP-FPM to connect to database ports
allow laravel_php_fpm_t mysqld_port_t:tcp_socket name_connect;
allow laravel_php_fpm_t postgresql_port_t:tcp_socket name_connect;

# Allow Nginx to connect to PHP-FPM (unix socket)
allow laravel_nginx_t laravel_php_fpm_t:unix_stream_socket connectto;

if (panel_can_manage_users) {
    # Grant user management permissions to panel (laravel_app_t)
    # detailed rules omitted for brevity, assuming standard macros or specifics
}

if (panel_can_reload_nginx) {
    # Grant nginx reload permissions
}