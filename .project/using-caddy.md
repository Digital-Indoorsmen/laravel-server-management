# Laravel Server Management Panel Architecture
## Caddy + Multi-PHP + SELinux

---

## Executive Summary

This document outlines a complete architecture for building a Laravel-based server management panel that:

- Uses **Caddy** as the primary web server (instead of Nginx)
- Hosts **multiple sites** with different **PHP versions** (7.4, 8.3, 8.4, 8.5, etc.)
- Runs on **SELinux-enabled** systems (RHEL, Rocky Linux, AlmaLinux, Fedora)
- Provides **dynamic site provisioning** via Laravel's admin interface

**FrankenPHP was evaluated and rejected** due to inability to support multiple PHP versions simultaneously and weaker isolation for multi-tenant hosting.

---

## Why Caddy Over Nginx

| Factor | Caddy | Nginx |
|--------|-------|-------|
| Configuration | Clean, declarative, JSON/Caddyfile | Verbose, error-prone |
| HTTPS | Automatic, zero-config | Manual Certbot setup |
| Dynamic API | Native REST API on :2019 | None—requires reloads |
| HTTP/3 | Built-in | Module required |
| Observability | Structured JSON logs | Parse + external tools |
| Memory safety | Memory-safe (Go) | Buffer overflow risk |

**Key advantage**: Caddy's API allows Laravel to programmatically add/remove sites without service restarts.

---

## Architecture Overview

<pre>
┌─────────────────────────────────────────┐
│           Caddy (Port 80/443)           │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │ site1.  │  │ site2.  │  │panel.   │ │
│  │ com     │  │ com     │  │yourapp. │ │
│  │ (PHP    │  │ (Node)  │  │ com     │ │
│  │ 7.4)    │  │ (3000)  │  │(Laravel)│ │
│  └────┬────┘  └────┬────┘  └────┬────┘ │
│       │            │            │      │
│   PHP-FPM      Node/Port     PHP-FPM   │
│   7.4 pool     (direct)      8.4 pool  │
│  (isolated)                  (panel)    │
└─────────────────────────────────────────┘
</pre>

---

## SELinux Configuration

### Required Packages

```bash
# Install Caddy with proper SELinux support
sudo dnf install 'dnf-command(copr)'
sudo dnf copr enable @caddy/caddy
sudo dnf install caddy

# Install SELinux management tools
sudo dnf install policycoreutils-python-utils setools-console
```

### File Contexts

```bash
# Web content (readable by Caddy)
sudo semanage fcontext -a -t httpd_sys_content_t "/var/www/sites(/.*)?"
sudo restorecon -Rv /var/www/sites

# PHP-FPM sockets (read/write for Caddy)
sudo semanage fcontext -a -t httpd_sys_rw_content_t "/run/php(/.*)?"
sudo restorecon -Rv /run/php

# Log files
sudo semanage fcontext -a -t httpd_log_t "/var/log/caddy(/.*)?"
sudo restorecon -Rv /var/log/caddy

# Panel storage (Caddy configs written by Laravel)
sudo semanage fcontext -a -t httpd_sys_rw_content_t "/var/www/panel/storage/caddy(/.*)?"
sudo restorecon -Rv /var/www/panel/storage/caddy
```

### Required Booleans

```bash
# Allow Caddy to connect to upstreams (Node, Python, etc.)
sudo setsebool -P httpd_can_network_connect 1

# Allow Caddy to connect to databases
sudo setsebool -P httpd_can_network_connect_db 1

# Allow Caddy to send mail
sudo setsebool -P httpd_can_sendmail 1
```

---

## Base Caddyfile

```caddyfile
# /etc/caddy/Caddyfile

# Import dynamic site configs generated by Laravel
import /var/www/panel/storage/caddy/sites/*.caddyfile

# The management panel itself
panel.yourapp.com {
    root * /var/www/panel/public
    encode gzip zstd
    php_fastcgi unix//run/php/php8.4-fpm-panel.sock
    file_server
    
    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}
```

---

## Dynamic Site Configuration (Laravel-Generated)

### Example Generated Caddyfile

```caddyfile
# /var/www/panel/storage/caddy/sites/example.com.caddyfile

example.com {
    root * /var/www/sites/example.com/public
    encode gzip zstd
    
    # PHP with specific version socket
    php_fastcgi unix//run/php/php8.4-fpm-site123.sock {
        resolve_root_symlink
    }
    
    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Rate limiting
    rate_limit {
        zone static_example {
            key static
            events 100
            window 1m
        }
    }
    
    file_server
}
```

---

## PHP-FPM Pool Configuration

### Per-Site Pool Template

```ini
; /etc/php/8.4/fpm/pool.d/site-123.conf
; Generated by Laravel for site ID 123

[site-123]
user = site123
group = site123
listen = /run/php/php8.4-fpm-site123.sock
listen.owner = www-data
listen.group = www-data
pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3
pm.max_requests = 500
pm.status_path = /php-status
ping.path = /ping

; Security hardening
chroot = /var/www/sites/example.com
chdir = /
php_admin_value[open_basedir] = /var/www/sites/example.com:/tmp:/var/log/php
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source
php_admin_flag[allow_url_fopen] = off
php_admin_value[error_log] = /var/log/php/site-123-errors.log
php_admin_flag[log_errors] = on
php_admin_value[memory_limit] = 128M
php_admin_value[max_execution_time] = 30
php_admin_value[max_input_vars] = 1000
```

---

## Laravel Implementation

### Database Migration

```php
<?php
// database/migrations/xxxx_create_sites_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('sites', function (Blueprint $table) {
            $table->id();
            $table->foreignId('server_id')->constrained();
            $table->string('domain')->unique();
            $table->string('document_root');
            $table->string('system_user');
            $table->string('php_version')->default('8.4');
            $table->json('aliases')->nullable();
            $table->json('environment_variables')->nullable();
            $table->json('redirect_rules')->nullable();
            $table->json('rewrites')->nullable();
            $table->integer('max_children')->default(5);
            $table->integer('start_servers')->default(2);
            $table->integer('min_spare_servers')->default(1);
            $table->integer('max_spare_servers')->default(3);
            $table->enum('status', ['pending', 'active', 'suspended'])->default('pending');
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('sites');
    }
};
```

### Caddy Manager Service

```php
<?php
// app/Services/CaddyManager.php

namespace App\Services;

use App\Models\Site;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Process;

class CaddyManager
{
    protected string $sitesPath;
    protected string $caddyApiUrl;

    public function __construct()
    {
        $this->sitesPath = storage_path('caddy/sites');
        $this->caddyApiUrl = 'http://localhost:2019';
    }

    public function addSite(Site $site): bool
    {
        $config = $this->generateCaddyfile($site);
        $path = "{$this->sitesPath}/{$site->domain}.caddyfile";
        
        File::ensureDirectoryExists(dirname($path));
        File::put($path, $config);
        
        $this->setSelinuxContext($path);
        
        return $this->reloadCaddy();
    }

    public function removeSite(Site $site): bool
    {
        $path = "{$this->sitesPath}/{$site->domain}.caddyfile";
        
        if (File::exists($path)) {
            File::delete($path);
            return $this->reloadCaddy();
        }
        
        return true;
    }

    protected function generateCaddyfile(Site $site): string
    {
        $socket = "/run/php/php{$site->php_version}-fpm-{$site->id}.sock";
        
        $aliases = collect($site->aliases ?? [])
            ->map(fn($alias) => ", {$alias}")
            ->join('');
        
        return <<<CADDY
{$site->domain}{$aliases} {
    root * {$site->document_root}
    encode gzip zstd
    
    php_fastcgi unix/{$socket} {
        resolve_root_symlink
    }
    
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    {$this->generateRewrites($site)}
    {$this->generateRedirects($site)}
    
    file_server
}
CADDY;
    }

    protected function generateRewrites(Site $site): string
    {
        if (empty($site->rewrites)) {
            return '';
        }
        
        $rules = collect($site->rewrites)
            ->map(fn($rewrite) => "rewrite {$rewrite['from']} {$rewrite['to']}")
            ->join("\n    ");
        
        return "handle {\n    {$rules}\n}";
    }

    protected function generateRedirects(Site $site): string
    {
        if (empty($site->redirect_rules)) {
            return '';
        }
        
        return collect($site->redirect_rules)
            ->map(fn($r) => "redir {$r['from']} {$r['to']} {$r['code']}")
            ->join("\n    ");
    }

    protected function setSelinuxContext(string $path): void
    {
        Process::run("sudo semanage fcontext -a -t httpd_config_t '{$path}' 2>/dev/null || true");
        Process::run("sudo restorecon -v '{$path}'");
    }

    protected function reloadCaddy(): bool
    {
        // Validate config first
        $validate = Process::run('sudo caddy validate --config /etc/caddy/Caddyfile');
        
        if (!$validate->successful()) {
            \Log::error('Caddy config validation failed: ' . $validate->errorOutput());
            return false;
        }
        
        // Graceful reload
        $result = Process::run('sudo systemctl reload caddy');
        
        return $result->successful();
    }
}
```

### PHP-FPM Manager Service

```php
<?php
// app/Services/PhpFpmManager.php

namespace App\Services;

use App\Models\Site;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\Process;

class PhpFpmManager
{
    public function createPool(Site $site): void
    {
        $version = $site->php_version;
        $poolDir = "/etc/php/{$version}/fpm/pool.d";
        $poolPath = "{$poolDir}/site-{$site->id}.conf";
        
        // Ensure PHP version is installed
        if (!is_dir($poolDir)) {
            throw new \RuntimeException("PHP {$version} is not installed");
        }
        
        $config = $this->generatePoolConfig($site);
        File::put($poolPath, $config);
        
        $this->setSelinuxContext($poolPath);
        $this->reloadPhpFpm($version);
    }

    public function removePool(Site $site): void
    {
        $version = $site->php_version;
        $poolPath = "/etc/php/{$version}/fpm/pool.d/site-{$site->id}.conf";
        
        if (File::exists($poolPath)) {
            File::delete($poolPath);
            $this->reloadPhpFpm($version);
        }
    }

    protected function generatePoolConfig(Site $site): string
    {
        return <<<CONF
[site-{$site->id}]
user = {$site->system_user}
group = {$site->system_user}
listen = /run/php/php{$site->php_version}-fpm-{$site->id}.sock
listen.owner = www-data
listen.group = www-data
pm = dynamic
pm.max_children = {$site->max_children}
pm.start_servers = {$site->start_servers}
pm.min_spare_servers = {$site->min_spare_servers}
pm.max_spare_servers = {$site->max_spare_servers}
pm.max_requests = 500
pm.status_path = /php-status
ping.path = /ping

chroot = {$site->document_root}
chdir = /
php_admin_value[open_basedir] = {$site->document_root}:/tmp:/var/log/php
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source
php_admin_flag[allow_url_fopen] = off
php_admin_value[error_log] = /var/log/php/site-{$site->id}-errors.log
php_admin_flag[log_errors] = on

; Environment variables
{$this->generateEnvVars($site)}
CONF;
    }

    protected function generateEnvVars(Site $site): string
    {
        $vars = $site->environment_variables ?? [];
        
        return collect($vars)
            ->map(fn($value, $key) => "env[{$key}] = {$value}")
            ->join("\n");
    }

    protected function setSelinuxContext(string $path): void
    {
        Process::run("sudo semanage fcontext -a -t httpd_config_t '{$path}' 2>/dev/null || true");
        Process::run("sudo restorecon -v '{$path}'");
    }

    protected function reloadPhpFpm(string $version): void
    {
        Process::run("sudo systemctl reload php{$version}-fpm");
    }
}
```

### Site Provisioner Service

```php
<?php
// app/Services/SiteProvisioner.php

namespace App\Services;

use App\Models\Site;
use Illuminate\Support\Facades\Process;

class SiteProvisioner
{
    public function __construct(
        protected CaddyManager $caddy,
        protected PhpFpmManager $phpFpm
    ) {}

    public function provision(Site $site): void
    {
        // 1. Create system user
        $this->createSystemUser($site);
        
        // 2. Create document root
        $this->createDocumentRoot($site);
        
        // 3. Create PHP-FPM pool
        $this->phpFpm->createPool($site);
        
        // 4. Generate Caddy config
        $this->caddy->addSite($site);
        
        // 5. Update status
        $site->update(['status' => 'active']);
    }

    public function deprovision(Site $site): void
    {
        $this->caddy->removeSite($site);
        $this->phpFpm->removePool($site);
        // Optionally: remove user, backup files, etc.
    }

    protected function createSystemUser(Site $site): void
    {
        Process::run("sudo useradd -r -s /bin/false -d {$site->document_root} {$site->system_user} 2>/dev/null || true");
    }

    protected function createDocumentRoot(Site $site): void
    {
        Process::run("sudo mkdir -p {$site->document_root}/public");
        Process::run("sudo chown -R {$site->system_user}:{$site->system_user} {$site->document_root}");
        Process::run("sudo chmod 755 {$site->document_root}");
        
        // SELinux context
        Process::run("sudo semanage fcontext -a -t httpd_sys_content_t '{$site->document_root}(/.*)?' 2>/dev/null || true");
        Process::run("sudo restorecon -Rv {$site->document_root}");
    }
}
```

---

## Non-PHP Site Support

### Node.js/Express Application

```caddyfile
node-app.example.com {
    reverse_proxy localhost:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        
        health_uri /health
        health_interval 10s
        fail_duration 30s
    }
    
    encode gzip zstd
}
```

### Python/Django Application

```caddyfile
django-app.example.com {
    reverse_proxy unix//run/gunicorn/django.sock {
        header_up Host {host}
    }
    
    encode gzip zstd
    
    # Static files served directly by Caddy
    handle_path /static/* {
        root * /var/www/sites/django/static
        file_server
    }
    
    # Media files
    handle_path /media/* {
        root * /var/www/sites/django/media
        file_server
    }
}
```

### Static Site

```caddyfile
static.example.com {
    root * /var/www/sites/static/public
    encode gzip zstd
    file_server {
        hide .git
        hide .env
    }
    
    # Cache headers for assets
    @static {
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
}
```

---

## Log Streaming (Real-time)

```php
<?php
// routes/web.php or routes/api.php

use App\Models\Site;
use Illuminate\Support\Facades\Process;
use Symfony\Component\HttpFoundation\StreamedResponse;

Route::get('/sites/{site}/logs', function (Site $site) {
    return new StreamedResponse(function () use ($site) {
        $logPath = "/var/log/caddy/{$site->domain}.log";
        
        // Check SELinux access first
        $check = Process::run("sudo -u caddy test -r {$logPath} && echo 'OK'");
        if (trim($check->output()) !== 'OK') {
            echo "data: " . json_encode(['error' => 'Log access denied by SELinux']) . "\n\n";
            return;
        }
        
        $process = proc_open(
            ['sudo', 'tail', '-f', '-n', '100', $logPath],
            [1 => ['pipe', 'w'], 2 => ['pipe', 'w']],
            $pipes
        );
        
        stream_set_blocking($pipes[1], false);
        
        while (true) {
            if (feof($pipes[1])) break;
            
            $line = fgets($pipes[1]);
            if ($line === false) {
                usleep(100000);
                continue;
            }
            
            $data = json_decode($line, true);
            echo "data: " . json_encode([
                'time' => $data['ts'] ?? null,
                'level' => $data['level'] ?? 'info',
                'msg' => $data['msg'] ?? '',
                'request' => [
                    'method' => $data['request']['method'] ?? null,
                    'uri' => $data['request']['uri'] ?? null,
                    'remote_ip' => $data['request']['remote_ip'] ?? null,
                    'status' => $data['status'] ?? null,
                ],
            ]) . "\n\n";
            
            ob_flush();
            flush();
        }
        
        fclose($pipes[1]);
        fclose($pipes[2]);
        proc_close($process);
    }, 200, [
        'Content-Type' => 'text/event-stream',
        'Cache-Control' => 'no-cache',
        'X-Accel-Buffering' => 'no',
    ]);
})->middleware(['auth', 'can:view,site']);
```

---

## Security Checklist

| Layer | Implementation |
|-------|---------------|
| **SELinux** | Enforcing mode, custom policies for Caddy/PHP-FPM |
| **User isolation** | Each site runs as unique Linux user |
| **PHP isolation** | open_basedir, chroot, disable_functions |
| **Network** | httpd_can_network_connect selectively enabled |
| **File permissions** | 755 dirs, 644 files, proper SELinux contexts |
| **Caddy headers** | X-Frame-Options, CSP, HSTS automatic |
| **Rate limiting** | Per-site via Caddy rate_limit directive |
| **Logging** | Separate error logs per site, centralized access |

---

## Commands Reference

```bash
# Validate Caddy config
sudo caddy validate --config /etc/caddy/Caddyfile

# Reload Caddy gracefully
sudo systemctl reload caddy

# Check SELinux status
getenforce
sestatus

# View Caddy logs
sudo journalctl -u caddy -f

# Check PHP-FPM pool status
sudo systemctl status php8.4-fpm
sudo cgi-fcgi -bind -connect /run/php/php8.4-fpm-site123.sock

# Audit SELinux denials
sudo ausearch -m AVC -ts recent
sudo sealert -a /var/log/audit/audit.log

# Test site config
curl -I -H "Host: example.com" http://localhost/
```

---

## Summary

| Decision | Rationale |
|----------|-----------|
| **Caddy over Nginx** | Native API, automatic HTTPS, simpler config generation |
| **PHP-FPM over FrankenPHP** | Multiple PHP versions, strong isolation, SELinux-friendly |
| **Per-site pools** | Resource limits, security boundaries, independent scaling |
| **SELinux enforcing** | Defense in depth, mandatory access controls |

This architecture provides a solid foundation for a multi-tenant hosting panel with modern tooling and strong security boundaries.
